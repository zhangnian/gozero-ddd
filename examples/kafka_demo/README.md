# Kafka é¢†åŸŸäº‹ä»¶ç¤ºä¾‹

æœ¬ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åœ¨ DDD æ¶æ„ä¸­ä½¿ç”¨ Kafka å®ç°é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒä¸è®¢é˜…ã€‚

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚ (Application)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Command       â”‚ â”€â”€å‘å¸ƒäº‹ä»¶â”€â”€â–¶      â”‚   Event Handlers    â”‚  â”‚
â”‚  â”‚   Handlers      â”‚                    â”‚   (äº‹ä»¶å¤„ç†å™¨)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                 â”‚
                â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é¢†åŸŸå±‚ (Domain)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Entity       â”‚â”€â”€â–¶ â”‚  Domain Event   â”‚    â”‚  Publisher   â”‚ â”‚
â”‚  â”‚    (å®ä½“)        â”‚    â”‚  (é¢†åŸŸäº‹ä»¶)      â”‚    â”‚   æ¥å£       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Kafka Event Bus                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚    Publisher    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     Consumer          â”‚ â”‚â”‚
â”‚  â”‚  â”‚    (å‘å¸ƒå™¨)      â”‚              â”‚     (æ¶ˆè´¹å™¨)          â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                    â”‚
               â–¼                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    Kafka                         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚           Topic: domain-events             â”‚  â”‚
        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
        â”‚  â”‚  â”‚Partitionâ”‚ â”‚Partitionâ”‚ â”‚Partitionâ”‚      â”‚  â”‚
        â”‚  â”‚  â”‚    0    â”‚ â”‚    1    â”‚ â”‚    2    â”‚      â”‚  â”‚
        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ é¢†åŸŸäº‹ä»¶ç±»å‹

| äº‹ä»¶åç§° | æè¿° | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `knowledge_base.created` | çŸ¥è¯†åº“åˆ›å»º | æ–°å»ºçŸ¥è¯†åº“ |
| `knowledge_base.updated` | çŸ¥è¯†åº“æ›´æ–° | ä¿®æ”¹çŸ¥è¯†åº“ä¿¡æ¯ |
| `knowledge_base.deleted` | çŸ¥è¯†åº“åˆ é™¤ | åˆ é™¤çŸ¥è¯†åº“ |
| `document.added` | æ–‡æ¡£æ·»åŠ  | å‘çŸ¥è¯†åº“æ·»åŠ æ–‡æ¡£ |
| `document.removed` | æ–‡æ¡£ç§»é™¤ | ä»çŸ¥è¯†åº“ç§»é™¤æ–‡æ¡£ |
| `document.updated` | æ–‡æ¡£æ›´æ–° | æ›´æ–°æ–‡æ¡£å†…å®¹ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ Kafka ç¯å¢ƒ

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹ Kafka æ—¥å¿—
docker-compose logs -f kafka
```

æœåŠ¡å¯åŠ¨åï¼š
- Kafka Broker: `localhost:9092`
- Kafka UI: `http://localhost:8080`
- Zookeeper: `localhost:2181`

### 2. å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### 3. è¿è¡Œæ¶ˆè´¹è€…

```bash
# ç»ˆç«¯ 1 - å¯åŠ¨æ¶ˆè´¹è€…ï¼ˆå…ˆå¯åŠ¨ï¼Œç­‰å¾…äº‹ä»¶ï¼‰
go run examples/kafka_demo/consumer/main.go
```

### 4. è¿è¡Œç”Ÿäº§è€…

```bash
# ç»ˆç«¯ 2 - å¯åŠ¨ç”Ÿäº§è€…ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰
go run examples/kafka_demo/producer/main.go
```

## ğŸ“Š Kafka UI ä½¿ç”¨

è®¿é—® http://localhost:8080 å¯ä»¥ï¼š
- æŸ¥çœ‹ Topics å’Œ Partitions
- æµè§ˆæ¶ˆæ¯å†…å®¹
- ç›‘æ§æ¶ˆè´¹è€…ç»„
- æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ

### äº‹ä»¶æ¶ˆæ¯ç»“æ„

```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "event_name": "knowledge_base.created",
  "aggregate_id": "kb-123456",
  "occurred_at": "2024-01-15T10:30:00Z",
  "payload": {
    "KnowledgeBaseID": "kb-123456",
    "Name": "æŠ€æœ¯æ–‡æ¡£åº“"
  },
  "metadata": {
    "trace_id": "trace-abc123",
    "service_name": "knowledge-service",
    "version": "1.0"
  }
}
```

### åˆ†åŒºç­–ç•¥

- ä½¿ç”¨ `AggregateID`ï¼ˆèšåˆæ ¹IDï¼‰ä½œä¸ºåˆ†åŒºé”®
- ä¿è¯åŒä¸€èšåˆæ ¹çš„äº‹ä»¶æŒ‰é¡ºåºå¤„ç†
- ä¸åŒèšåˆæ ¹çš„äº‹ä»¶å¯ä»¥å¹¶è¡Œå¤„ç†

### æ¶ˆè´¹è€…ç»„

- åŒä¸€æ¶ˆè´¹è€…ç»„å†…çš„æ¶ˆè´¹è€…åˆ†æ‹…åˆ†åŒº
- ä¸åŒæ¶ˆè´¹è€…ç»„ç‹¬ç«‹æ¶ˆè´¹ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰
- æ”¯æŒæ¶ˆè´¹è€…åŠ¨æ€ä¼¸ç¼©

## ğŸ”§ é…ç½®è¯´æ˜

### Kafka äº‹ä»¶æ€»çº¿é…ç½®

```go
config := eventbus.KafkaConfig{
    Brokers:         []string{"localhost:9092"},  // Kafka åœ°å€
    Topic:           "domain-events",              // äº‹ä»¶ä¸»é¢˜
    GroupID:         "knowledge-service",          // æ¶ˆè´¹è€…ç»„
    WriteTimeout:    10 * time.Second,             // å†™å…¥è¶…æ—¶
    ReadTimeout:     10 * time.Second,             // è¯»å–è¶…æ—¶
    BatchSize:       100,                          // æ‰¹é‡å¤§å°
    BatchTimeout:    time.Second,                  // æ‰¹é‡è¶…æ—¶
    RequiredAcks:    -1,                          // ç¡®è®¤æ¨¡å¼
    Async:           false,                        // åŒæ­¥/å¼‚æ­¥
    AutoCreateTopic: true,                         // è‡ªåŠ¨åˆ›å»ºä¸»é¢˜
}
```

## ğŸ“ ä»£ç ç¤ºä¾‹

### å‘å¸ƒäº‹ä»¶

```go
// åˆ›å»ºå‘å¸ƒå™¨
publisher, _ := eventbus.NewKafkaEventPublisher(config)
defer publisher.Close()

// åˆ›å»ºé¢†åŸŸäº‹ä»¶
evt := event.NewKnowledgeBaseCreatedEvent(kbID, "æŠ€æœ¯æ–‡æ¡£åº“")

// å‘å¸ƒåˆ° Kafka
ctx := context.Background()
publisher.Publish(ctx, evt)
```

### è®¢é˜…äº‹ä»¶

```go
// åˆ›å»ºæ¶ˆè´¹å™¨
consumer := eventbus.NewKafkaEventConsumer(config)

// æ³¨å†Œå¤„ç†å™¨
consumer.Subscribe("knowledge_base.created", &MyHandler{})
consumer.SubscribeAll(&AuditLogHandler{})  // å…¨å±€å¤„ç†å™¨

// å¯åŠ¨æ¶ˆè´¹
ctx := context.Background()
consumer.Start(ctx)
```

### è‡ªå®šä¹‰å¤„ç†å™¨

```go
type MyHandler struct{}

func (h *MyHandler) EventName() string {
    return "knowledge_base.created"
}

func (h *MyHandler) Handle(ctx context.Context, evt event.DomainEvent) error {
    // å¤„ç†äº‹ä»¶é€»è¾‘
    log.Printf("æ”¶åˆ°äº‹ä»¶: %s", evt.EventName())
    return nil
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¹‚ç­‰æ€§**: æ¶ˆè´¹è€…å¤„ç†é€»è¾‘åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸ºæ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’
2. **é¡ºåºæ€§**: åªæœ‰åŒä¸€åˆ†åŒºå†…çš„æ¶ˆæ¯ä¿è¯é¡ºåºï¼Œè·¨åˆ†åŒºæ— é¡ºåºä¿è¯
3. **é”™è¯¯å¤„ç†**: ç”Ÿäº§ç¯å¢ƒéœ€è¦å®ç°é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶
4. **äº‹åŠ¡**: å¦‚éœ€äº‹åŠ¡ä¸€è‡´æ€§ï¼Œè€ƒè™‘ä½¿ç”¨ Kafka äº‹åŠ¡æˆ– Outbox æ¨¡å¼

## ğŸ§¹ æ¸…ç†ç¯å¢ƒ

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åˆ é™¤æ•°æ®å·ï¼ˆå½»åº•æ¸…ç†ï¼‰
docker-compose down -v
```

